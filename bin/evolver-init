#!/usr/bin/env bash
###############################################################################
# Evolver Init - Initialize the EvolveR experience base environment
#
# This script:
# 1. Creates ~/.evolver directory
# 2. Initializes the SQLite database
# 3. Sets up hooks for Claude Code (optional)
###############################################################################

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
EVOLVER_HOME="${EVOLVER_HOME:-$HOME/.evolver}"
EVOLVER_DB_PATH="${EVOLVER_DB_PATH:-$EVOLVER_HOME/expbase.db}"

# Get the directory of this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

log() {
  echo -e "${BLUE}[evolver-init]${NC} $*"
}

log_success() {
  echo -e "${GREEN}[evolver-init]${NC} $*"
}

log_warn() {
  echo -e "${YELLOW}[evolver-init]${NC} $*"
}

log_error() {
  echo -e "${RED}[evolver-init]${NC} $*"
}

print_help() {
  cat <<EOF
Evolver Init - Initialize the EvolveR experience base

Usage:
  evolver-init [options]

Options:
  --home=PATH        Set EVOLVER_HOME directory (default: ~/.evolver)
  --db=PATH          Set database path (default: ~/.evolver/expbase.db)
  --install-hooks    Install Claude Code hooks
  --force            Overwrite existing configuration
  --help             Show this help

Examples:
  # Basic initialization
  evolver-init

  # Initialize with hooks
  evolver-init --install-hooks

  # Custom paths
  evolver-init --home=/custom/path --db=/custom/db.sqlite

Environment Variables:
  EVOLVER_HOME       Base directory for evolver data
  EVOLVER_DB_PATH    Path to SQLite database
EOF
}

install_hooks() {
  local target_dir="$1"
  local force="$2"

  log "Installing Claude Code hooks..."

  # Check if .claude directory exists in current project
  if [ ! -d ".claude" ]; then
    mkdir -p ".claude"
    log "Created .claude directory"
  fi

  local hooks_file=".claude/hooks.json"
  local example_file="$PROJECT_ROOT/.claude/hooks.json.example"

  if [ -f "$hooks_file" ] && [ "$force" != "true" ]; then
    log_warn "hooks.json already exists. Use --force to overwrite"
    return 0
  fi

  if [ ! -f "$example_file" ]; then
    log_error "hooks.json.example not found at $example_file"
    return 1
  fi

  # Copy and customize hooks file
  cp "$example_file" "$hooks_file"

  # Update paths in hooks.json to use absolute paths
  if command -v sed &> /dev/null; then
    sed -i.bak "s|hooks/|$PROJECT_ROOT/hooks/|g" "$hooks_file"
    rm -f "$hooks_file.bak"
  fi

  log_success "Installed hooks to $hooks_file"

  # Show reminder about environment
  log ""
  log "Hooks installed. Make sure to set environment variables:"
  log "  export EVOLVER_DB_PATH=\"$EVOLVER_DB_PATH\""
  log "  export EVOLVER_STATE_FILE=\"/tmp/evolver-harness-session.json\""
}

init_database() {
  local db_path="$1"

  log "Initializing database at $db_path..."

  # Check if bun or node is available
  local runtime=""
  if command -v bun &> /dev/null; then
    runtime="bun"
  elif command -v node &> /dev/null; then
    runtime="node"
  else
    log_error "Neither bun nor node found. Please install one of them."
    exit 1
  fi

  # Run a quick initialization script
  $runtime -e "
    import { ExpBaseStorage } from '$PROJECT_ROOT/src/storage/expbase.ts';
    const storage = new ExpBaseStorage({ dbPath: '$db_path' });
    const stats = storage.getStats();
    console.log(JSON.stringify(stats, null, 2));
    storage.close();
  " 2>/dev/null || {
    # Fallback: just create the directory, database will be created on first use
    log_warn "Could not pre-initialize database (will be created on first use)"
  }
}

main() {
  local install_hooks_flag="false"
  local force="false"

  # Parse arguments
  while [ $# -gt 0 ]; do
    case "$1" in
      --home=*)
        EVOLVER_HOME="${1#*=}"
        EVOLVER_DB_PATH="$EVOLVER_HOME/expbase.db"
        ;;
      --db=*)
        EVOLVER_DB_PATH="${1#*=}"
        ;;
      --install-hooks)
        install_hooks_flag="true"
        ;;
      --force)
        force="true"
        ;;
      --help|-h)
        print_help
        exit 0
        ;;
      *)
        log_error "Unknown option: $1"
        print_help
        exit 1
        ;;
    esac
    shift
  done

  log "Initializing EvolveR environment..."
  log "  EVOLVER_HOME: $EVOLVER_HOME"
  log "  EVOLVER_DB_PATH: $EVOLVER_DB_PATH"
  log ""

  # Create evolver home directory
  if [ ! -d "$EVOLVER_HOME" ]; then
    mkdir -p "$EVOLVER_HOME"
    log_success "Created $EVOLVER_HOME"
  else
    log "Directory $EVOLVER_HOME already exists"
  fi

  # Create database directory if different
  local db_dir
  db_dir="$(dirname "$EVOLVER_DB_PATH")"
  if [ "$db_dir" != "$EVOLVER_HOME" ] && [ ! -d "$db_dir" ]; then
    mkdir -p "$db_dir"
    log_success "Created $db_dir"
  fi

  # Initialize database
  init_database "$EVOLVER_DB_PATH"

  # Install hooks if requested
  if [ "$install_hooks_flag" = "true" ]; then
    install_hooks "$PROJECT_ROOT" "$force"
  fi

  log ""
  log_success "EvolveR initialized successfully!"
  log ""
  log "Next steps:"
  log "  1. Add to your shell profile:"
  log "     export EVOLVER_DB_PATH=\"$EVOLVER_DB_PATH\""
  log ""
  log "  2. Start using evolver:"
  log "     evolver --task=\"Your task description\""
  log ""
  log "  3. Run distillation after sessions:"
  log "     bun $PROJECT_ROOT/src/distiller/cli.ts distill"
  log ""

  if [ "$install_hooks_flag" != "true" ]; then
    log "  Tip: Run with --install-hooks to enable automatic trace collection"
  fi
}

main "$@"

