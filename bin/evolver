#!/usr/bin/env bash
###############################################################################
# Evolver - Experience-Augmented Claude Code Wrapper
#
# This script wraps Claude Code sessions with experience base context:
# 1. Retrieves relevant principles for the task
# 2. Injects them into environment/CLAUDE.md or context file
# 3. Launches Claude Code with the augmented context
# 4. Collects trace on exit
# 5. Triggers distillation if needed
#
# Usage:
#   evolver --task="Fix the login bug"
#   evolver --task="Add dark mode" --no-trace
#   evolver status
#   evolver sync
###############################################################################

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration from environment
EVOLVER_DB_PATH="${EVOLVER_DB_PATH:-$HOME/.evolver/expbase.db}"
EVOLVER_CONTEXT_FILE="${EVOLVER_CONTEXT_FILE:-$HOME/.evolver/context.md}"
EVOLVER_ENABLE_EMBEDDINGS="${EVOLVER_ENABLE_EMBEDDINGS:-false}"
EVOLVER_VERBOSE="${EVOLVER_VERBOSE:-false}"

# Get the directory of this script
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# CLI path
CLI_PATH="$PROJECT_ROOT/src/orchestrator/cli.ts"

###############################################################################
# Helper Functions
###############################################################################

log() {
  echo -e "${BLUE}[evolver]${NC} $*" >&2
}

log_success() {
  echo -e "${GREEN}[evolver]${NC} $*" >&2
}

log_warn() {
  echo -e "${YELLOW}[evolver]${NC} $*" >&2
}

log_error() {
  echo -e "${RED}[evolver]${NC} $*" >&2
}

print_help() {
  cat <<EOF
Evolver - Experience-Augmented Claude Code

Usage:
  evolver --task="<description>"    Wrap a Claude Code session
  evolver status                    Show experience base status
  evolver sync                      Sync principles to CLAUDE.md
  evolver search --query="<text>"   Search experience base
  evolver help                      Show this help

Options:
  --task=<text>       Task description for the session (required for wrap)
  --no-trace          Disable trace collection (runs vanilla Claude Code)
  --no-inject         Don't inject context (just retrieve and log)
  --session-id=<id>   Use specific session ID
  --verbose           Enable verbose logging

Environment Variables:
  EVOLVER_DB_PATH              Path to ExpBase database
                               (default: ~/.evolver/expbase.db)

  EVOLVER_CONTEXT_FILE         Path to context injection file
                               (default: ~/.evolver/context.md)

  EVOLVER_ENABLE_EMBEDDINGS    Enable semantic search (true/false)
                               (default: false)

  EVOLVER_VERBOSE              Enable verbose logging (true/false)
                               (default: false)

  OPENAI_API_KEY               OpenAI API key (required for embeddings)

Examples:
  # Wrap a Claude Code session with experience
  evolver --task="Fix authentication bug in OAuth flow"

  # Check status
  evolver status

  # Sync principles to project CLAUDE.md
  evolver sync

  # Search for relevant experience
  evolver search --query="react performance optimization"

Notes:
  - First run: Make sure ExpBase is initialized
  - Traces are automatically collected during sessions
  - Run 'evolver sync' periodically to update project guidance
EOF
}

###############################################################################
# Commands
###############################################################################

wrap_session() {
  local task="$1"
  local session_id="${2:-}"
  local no_trace="${3:-false}"
  local no_inject="${4:-false}"

  log "Wrapping Claude Code session"
  log "Task: $task"

  # Generate session ID if not provided
  if [ -z "$session_id" ]; then
    session_id="$(uuidgen 2>/dev/null || cat /proc/sys/kernel/random/uuid 2>/dev/null || echo "session-$(date +%s)")"
  fi

  log "Session ID: $session_id"

  # Prepare context using CLI
  local wrap_args=(wrap "--task=$task" "--session-id=$session_id")

  if ! result=$(node "$CLI_PATH" "${wrap_args[@]}" 2>&1); then
    log_error "Failed to prepare session context"
    echo "$result" >&2
    exit 1
  fi

  log_success "Context prepared successfully"

  # Parse result
  principles_count=$(echo "$result" | jq -r '.principlesRetrieved' 2>/dev/null || echo "0")
  context_file=$(echo "$result" | jq -r '.contextFile' 2>/dev/null || echo "$EVOLVER_CONTEXT_FILE")

  log "Retrieved $principles_count relevant principles"
  log "Context file: $context_file"

  if [ "$no_inject" = "true" ]; then
    log_warn "Context injection disabled (--no-inject)"
    echo "$result"
    exit 0
  fi

  # Inject context into project CLAUDE.md if it exists
  if [ -f "./CLAUDE.md" ] && [ -f "$context_file" ]; then
    log "Injecting principles into ./CLAUDE.md"

    # Backup existing CLAUDE.md
    cp "./CLAUDE.md" "./CLAUDE.md.backup"

    # Append evolver context
    echo "" >> "./CLAUDE.md"
    echo "# Evolver Context (Session: $session_id)" >> "./CLAUDE.md"
    echo "" >> "./CLAUDE.md"
    cat "$context_file" >> "./CLAUDE.md"
  fi

  if [ "$no_trace" = "true" ]; then
    log_warn "Trace collection disabled (--no-trace)"
    log "Launching Claude Code (vanilla mode)..."
    exec claude
  else
    log "Launching Claude Code with trace collection..."
    log_warn "Remember: Use 'claude-end' or exit normally to save trace"

    # Set environment for hooks
    export EVOLVER_SESSION_ID="$session_id"
    export EVOLVER_TASK="$task"

    # Launch Claude Code
    # Note: Hooks should be configured in .claude/hooks.json
    exec claude
  fi
}

status_command() {
  log "Checking experience base status..."

  if ! result=$(node "$CLI_PATH" status 2>&1); then
    log_error "Failed to get status"
    echo "$result" >&2
    exit 1
  fi

  echo "$result"
}

sync_command() {
  local output="${1:-./CLAUDE.md}"
  local max="${2:-20}"
  local min_score="${3:-0.6}"

  log "Syncing principles to $output"
  log "Max: $max, Min score: $min_score"

  local sync_args=(sync "--output=$output" "--max=$max" "--min-score=$min_score")

  if ! result=$(node "$CLI_PATH" "${sync_args[@]}" 2>&1); then
    log_error "Failed to sync principles"
    echo "$result" >&2
    exit 1
  fi

  log_success "Principles synced successfully"
  echo "$result"
}

search_command() {
  local query="$1"
  shift

  log "Searching experience base for: $query"

  local search_args=(search "--query=$query")

  # Add any additional args
  for arg in "$@"; do
    search_args+=("$arg")
  done

  if ! result=$(node "$CLI_PATH" "${search_args[@]}" 2>&1); then
    log_error "Failed to search experience base"
    echo "$result" >&2
    exit 1
  fi

  echo "$result"
}

###############################################################################
# Main
###############################################################################

main() {
  # Check if node is available
  if ! command -v node &> /dev/null; then
    log_error "node is not installed or not in PATH"
    exit 1
  fi

  # Check if CLI exists
  if [ ! -f "$CLI_PATH" ]; then
    log_error "CLI not found at $CLI_PATH"
    exit 1
  fi

  # Parse arguments
  local command=""
  local task=""
  local session_id=""
  local no_trace="false"
  local no_inject="false"
  local query=""
  local output="./CLAUDE.md"
  local max="20"
  local min_score="0.6"

  if [ $# -eq 0 ]; then
    print_help
    exit 0
  fi

  # First positional argument is the command (unless it's an option)
  if [[ ! "$1" =~ ^-- ]]; then
    command="$1"
    shift
  fi

  # Parse options
  while [ $# -gt 0 ]; do
    case "$1" in
      --task=*)
        task="${1#*=}"
        if [ -z "$command" ]; then
          command="wrap"
        fi
        ;;
      --task)
        if [ $# -lt 2 ]; then
          log_error "--task requires an argument"
          exit 1
        fi
        task="$2"
        if [ -z "$command" ]; then
          command="wrap"
        fi
        shift
        ;;
      --session-id=*)
        session_id="${1#*=}"
        ;;
      --session-id)
        if [ $# -lt 2 ]; then
          log_error "--session-id requires an argument"
          exit 1
        fi
        session_id="$2"
        shift
        ;;
      --no-trace)
        no_trace="true"
        ;;
      --no-inject)
        no_inject="true"
        ;;
      --query=*)
        query="${1#*=}"
        if [ -z "$command" ]; then
          command="search"
        fi
        ;;
      --query)
        if [ $# -lt 2 ]; then
          log_error "--query requires an argument"
          exit 1
        fi
        query="$2"
        if [ -z "$command" ]; then
          command="search"
        fi
        shift
        ;;
      --output=*)
        output="${1#*=}"
        ;;
      --max=*)
        max="${1#*=}"
        ;;
      --min-score=*)
        min_score="${1#*=}"
        ;;
      --verbose)
        export EVOLVER_VERBOSE="true"
        ;;
      --help|-h)
        print_help
        exit 0
        ;;
      *)
        log_error "Unknown option: $1"
        print_help
        exit 1
        ;;
    esac
    shift
  done

  # Execute command
  case "$command" in
    wrap)
      if [ -z "$task" ]; then
        log_error "--task is required for wrap command"
        exit 1
      fi
      wrap_session "$task" "$session_id" "$no_trace" "$no_inject"
      ;;

    status)
      status_command
      ;;

    sync)
      sync_command "$output" "$max" "$min_score"
      ;;

    search)
      if [ -z "$query" ]; then
        log_error "--query is required for search command"
        exit 1
      fi
      search_command "$query"
      ;;

    help|--help|-h)
      print_help
      ;;

    "")
      log_error "No command specified"
      print_help
      exit 1
      ;;

    *)
      log_error "Unknown command: $command"
      print_help
      exit 1
      ;;
  esac
}

main "$@"

